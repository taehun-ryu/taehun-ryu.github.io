<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window.location.pathname !== "/") return;

    var contentCards = Array.from(document.querySelectorAll('div[role="article"]')).filter(
      function (card) {
        return !!card.querySelector('h3 a[href^="/projects/"], h3 a[href^="/teaching/"]');
      },
    );

    contentCards.forEach(async function (card) {
      var titleLink = card.querySelector('h3 a[href^="/projects/"], h3 a[href^="/teaching/"]');
      var tagRow = card.querySelector(".flex.items-center.gap-2");
      if (!titleLink || !tagRow) return;
      if (tagRow.querySelectorAll("a").length >= 2) return;

      var contentPath = new URL(titleLink.href, window.location.origin).pathname;

      try {
        var res = await fetch(contentPath);
        if (!res.ok) return;
        var html = await res.text();
        var doc = new DOMParser().parseFromString(html, "text/html");

        var seen = new Set();
        var tags = Array.from(doc.querySelectorAll('a[href^="/tags/"]'))
          .map(function (a) {
            return {
              href: a.getAttribute("href"),
              label: (a.textContent || "").trim(),
            };
          })
          .filter(function (t) {
            if (!t.href || !t.label) return false;
            if (seen.has(t.href)) return false;
            seen.add(t.href);
            return true;
          });

        if (tags.length < 2) return;

        var template = tagRow.querySelector("a");
        if (!template) return;

        tagRow.innerHTML = "";
        tags.slice(0, 3).forEach(function (t) {
          var chip = template.cloneNode(true);
          chip.setAttribute("href", t.href);
          var textNode = chip.querySelector("span");
          if (textNode) textNode.textContent = t.label;
          tagRow.appendChild(chip);
        });
      } catch (_err) {
        // Ignore and keep default one-tag rendering.
      }
    });
  });
</script>
