{{- $item := .item -}}
{{- $authors := $item.Params.authors | default (slice) -}}
{{- $notes := $item.Params.author_notes | default (slice) -}}
{{- $total := len $authors -}}
{{- $image := $item.Resources.GetMatch "featured*" -}}
{{- if not $image -}}
  {{- $image = $item.Resources.GetMatch "cover*" -}}
{{- end -}}
{{- if not $image -}}
  {{- $image = $item.Resources.GetMatch "thumbnail*" -}}
{{- end -}}
{{- $thumb := $image -}}
{{- if $image -}}
  {{- $thumb = $image.Fit "640x360" -}}
{{- end -}}

<div class="pub-list-item view-citation-with-image" style="margin-bottom: 2.25rem">
  <div class="flex flex-col md:flex-row items-start gap-6">
    {{- if $thumb -}}
      <a href="{{ $item.RelPermalink }}" class="block w-full md:w-[35%] shrink-0">
        <img
          src="{{ $thumb.RelPermalink }}"
          alt="{{ $item.Title }}"
          width="{{ $thumb.Width }}"
          height="{{ $thumb.Height }}"
          class="w-full h-auto rounded-lg border border-gray-200 dark:border-gray-700"
          loading="lazy"
        />
      </a>
    {{- end -}}

    <div class="min-w-0 flex-1">
      <div class="text-lg leading-relaxed">
        <span class="article-metadata li-cite-author">
          {{- range $idx, $author := $authors -}}
            {{- $name := $author -}}
            {{- if eq $author "me" -}}
              {{- with $item.Site.Data.authors.me.name.display -}}
                {{- $name = . -}}
              {{- end -}}
            {{- else -}}
              {{- with index $item.Site.Data.authors $author -}}
                {{- with .name.display -}}
                  {{- $name = . -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}

            <span>{{ $name }}</span>

            {{- if lt $idx (len $notes) -}}
              {{- $note := index $notes $idx -}}
              {{- if ne (trim $note " ") "" -}}
                <span class="relative inline-block ml-1" x-data="{ tooltip: false }">
                  <button
                    @mouseenter="tooltip = true"
                    @mouseleave="tooltip = false"
                    @click="tooltip = !tooltip"
                    class="author-notes text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 transition-colors cursor-help"
                    data-tooltip="{{ $note }}"
                    aria-label="{{ $note }}"
                    type="button"
                  >
                    <svg class="inline-block w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  <div
                    x-show="tooltip"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform scale-95"
                    x-transition:enter-end="opacity-100 transform scale-100"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="opacity-100 transform scale-100"
                    x-transition:leave-end="opacity-0 transform scale-95"
                    @click.away="tooltip = false"
                    class="absolute z-50 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-sm text-white bg-gray-900 dark:bg-gray-700 rounded-lg shadow-lg whitespace-nowrap"
                    x-cloak
                  >
                    {{ $note }}
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900 dark:border-t-gray-700"></div>
                  </div>
                </span>
              {{- end -}}
            {{- end -}}

            {{ if lt $idx (sub $total 1) }}{{ if eq $idx (sub $total 2) }}, and {{ else }}, {{ end }}{{ end }}
          {{- end -}}
        </span>. <a href="{{ $item.RelPermalink }}" class="underline">{{ $item.Title }}</a>. {{ with ($item.Params.publication_short | default $item.Params.publication) }}<em>{{ . | markdownify | plainify }}</em>. {{ end }}{{ $item.Date.Format "2006" }}.
      </div>

      <div class="mt-2 flex flex-wrap space-x-3">
        {{ partial "page_links" (dict "page" $item "is_list" 1) }}
      </div>

      {{- with $item.Params.summary -}}
        {{- $summary := . | markdownify | plainify | truncate 180 -}}
        <p class="mt-3 text-base text-gray-700 dark:text-gray-300 leading-relaxed">
          {{ $summary }}
        </p>
      {{- end -}}
    </div>
  </div>
</div>
